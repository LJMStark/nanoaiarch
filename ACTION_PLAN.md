# ä»£ç å®¡æŸ¥ - è¡ŒåŠ¨è®¡åˆ’

## ğŸ“Š æ‰§è¡Œæ¦‚è§ˆ

| ä¼˜å…ˆçº§ | ä»»åŠ¡æ•° | é¢„è®¡å·¥æ—¶ | å®ŒæˆçŠ¶æ€ |
|--------|--------|----------|----------|
| P0     | 2      | 5h       | â³ å¾…å¼€å§‹ |
| P1     | 3      | 3.5h     | â³ å¾…å¼€å§‹ |
| P2     | 3      | 18h      | â³ å¾…å¼€å§‹ |
| **æ€»è®¡** | **8** | **26.5h** | **0%** |

---

## ğŸ”´ P0: ä¸¥é‡é—®é¢˜ï¼ˆéœ€ç«‹å³ä¿®å¤ï¼‰

### Task 1: ä¿®å¤ useGenerationRecovery æ€§èƒ½é—®é¢˜
**è´Ÿè´£äºº**: [å¾…åˆ†é…]
**å·¥æ—¶ä¼°è®¡**: 2å°æ—¶
**æˆªæ­¢æ—¥æœŸ**: [æœ¬å‘¨äº”]

**å­ä»»åŠ¡**:
- [ ] ä»ä¾èµ–æ•°ç»„ä¸­ç§»é™¤æœªä½¿ç”¨çš„ `messages`
- [ ] åˆ›å»ºæ–°çš„ server action: `getMessageStatus(projectId, messageId)`
- [ ] æ›´æ–° hook ä½¿ç”¨æ–° API è€Œä¸æ˜¯ `getProjectMessages`
- [ ] æœ¬åœ°æµ‹è¯•éªŒè¯æ€§èƒ½æ”¹è¿›

**æˆåŠŸæ ‡å‡†**:
- âœ… ä¾èµ–æ•°ç»„ä¸å†åŒ…å« `messages`
- âœ… ç½‘ç»œè¯·æ±‚æ•°æ®é‡å‡å°‘ 90%+
- âœ… interval ä¸ä¼šå› æ¶ˆæ¯æ›´æ–°è€Œé‡å»º

**ç›¸å…³æ–‡ä»¶**:
- `src/ai/image/hooks/use-generation-recovery.ts`
- `src/actions/project-message.ts` (æ–°å¢ API)

**å‚è€ƒ**: è§ `REFACTOR_EXAMPLES.md` ç¬¬ 1 éƒ¨åˆ†

---

### Task 2: æ·»åŠ è½®è¯¢é”™è¯¯æ¢å¤æœºåˆ¶
**è´Ÿè´£äºº**: [å¾…åˆ†é…]
**å·¥æ—¶ä¼°è®¡**: 3å°æ—¶
**æˆªæ­¢æ—¥æœŸ**: [æœ¬å‘¨äº”]

**å­ä»»åŠ¡**:
- [ ] æ·»åŠ  `MAX_RETRIES` å¸¸é‡ï¼ˆå»ºè®® 12ï¼‰
- [ ] æ·»åŠ  `MAX_POLL_DURATION_MS` å¸¸é‡ï¼ˆå»ºè®® 5åˆ†é’Ÿï¼‰
- [ ] å®ç°é‡è¯•è®¡æ•°é€»è¾‘
- [ ] å®ç°è¶…æ—¶æ£€æµ‹é€»è¾‘
- [ ] æ·»åŠ æ—¥å¿—è®°å½•
- [ ] æµ‹è¯•å„ç§å¤±è´¥åœºæ™¯

**æˆåŠŸæ ‡å‡†**:
- âœ… æœ€å¤šè½®è¯¢ 12 æ¬¡æˆ– 5 åˆ†é’Ÿåè‡ªåŠ¨åœæ­¢
- âœ… æ—¥å¿—æ¸…æ™°è®°å½•è½®è¯¢çŠ¶æ€å’Œå¤±è´¥åŸå› 
- âœ… å¼‚å¸¸æƒ…å†µä¸‹ä¸ä¼šæ— é™è½®è¯¢

**ç›¸å…³æ–‡ä»¶**:
- `src/ai/image/hooks/use-generation-recovery.ts`
- `src/ai/image/config/generation-recovery.ts` (æ–°å¢)

**å‚è€ƒ**: è§ `REFACTOR_EXAMPLES.md` ç¬¬ 1ã€5 éƒ¨åˆ†

---

## ğŸŸ¡ P1: é‡è¦é—®é¢˜ï¼ˆåº”å°½å¿«ä¿®å¤ï¼‰

### Task 3: æ”¹è¿› TypeScript ç±»å‹å®‰å…¨
**è´Ÿè´£äºº**: [å¾…åˆ†é…]
**å·¥æ—¶ä¼°è®¡**: 1å°æ—¶
**æˆªæ­¢æ—¥æœŸ**: [ä¸‹å‘¨ä¸‰]

**å­ä»»åŠ¡**:
- [ ] å®šä¹‰ `TranslationFunction` æ¥å£
- [ ] æ›¿æ¢ `parseErrorMessage` å‡½æ•°çš„ `any` ç±»å‹
- [ ] éªŒè¯ç±»å‹æ£€æŸ¥æ­£å¸¸å·¥ä½œ
- [ ] ç¡®ä¿æ„å»ºæ— ç±»å‹é”™è¯¯

**æˆåŠŸæ ‡å‡†**:
- âœ… ä¸å†ä½¿ç”¨ `any` ç±»å‹
- âœ… TypeScript ç¼–è¯‘é€šè¿‡
- âœ… IDE ç±»å‹æç¤ºæ­£å¸¸

**ç›¸å…³æ–‡ä»¶**:
- `src/ai/image/components/conversation/MessageItem.tsx`

**å‚è€ƒ**: è§ `REFACTOR_EXAMPLES.md` ç¬¬ 2 éƒ¨åˆ†

---

### Task 4: ç§»é™¤é‡å¤çš„åŠ¨æ€å¯¼å…¥
**è´Ÿè´£äºº**: [å¾…åˆ†é…]
**å·¥æ—¶ä¼°è®¡**: 0.5å°æ—¶
**æˆªæ­¢æ—¥æœŸ**: [ä¸‹å‘¨ä¸‰]

**å­ä»»åŠ¡**:
- [ ] å°† `updateAssistantMessage` ç§»åˆ°æ–‡ä»¶é¡¶éƒ¨å¯¼å…¥
- [ ] ç§»é™¤ä¸‰å¤„åŠ¨æ€å¯¼å…¥ä»£ç 
- [ ] æµ‹è¯•åŠŸèƒ½æ­£å¸¸

**æˆåŠŸæ ‡å‡†**:
- âœ… åªæœ‰ä¸€å¤„å¯¼å…¥è¯­å¥
- âœ… ä»£ç æ›´ç®€æ´æ˜“è¯»
- âœ… åŠŸèƒ½æ— å˜åŒ–

**ç›¸å…³æ–‡ä»¶**:
- `src/ai/image/components/conversation/ConversationInput.tsx`

**å‚è€ƒ**: è§ `REFACTOR_EXAMPLES.md` ç¬¬ 3 éƒ¨åˆ†

---

### Task 5: æ·»åŠ  localStorage é”™è¯¯å¤„ç†
**è´Ÿè´£äºº**: [å¾…åˆ†é…]
**å·¥æ—¶ä¼°è®¡**: 2å°æ—¶
**æˆªæ­¢æ—¥æœŸ**: [ä¸‹å‘¨äº”]

**å­ä»»åŠ¡**:
- [ ] åˆ›å»ºè‡ªå®šä¹‰ storage å¯¹è±¡with try-catch
- [ ] æ·»åŠ  QuotaExceededError å¤„ç†é€»è¾‘
- [ ] å®ç° version å’Œ migrate å‡½æ•°
- [ ] æ·»åŠ  onRehydrateStorage å›è°ƒ
- [ ] æµ‹è¯•å„ç§é”™è¯¯åœºæ™¯

**æˆåŠŸæ ‡å‡†**:
- âœ… localStorage æ»¡æ—¶æœ‰ä¼˜é›…é™çº§
- âœ… localStorage è¢«ç¦ç”¨æ—¶ä¸å´©æºƒ
- âœ… æ”¯æŒæ•°æ®ç»“æ„ç‰ˆæœ¬è¿ç§»
- âœ… æœ‰å®Œå–„çš„é”™è¯¯æ—¥å¿—

**ç›¸å…³æ–‡ä»¶**:
- `src/stores/conversation-store.ts`

**å‚è€ƒ**: è§ `REFACTOR_EXAMPLES.md` ç¬¬ 4 éƒ¨åˆ†

---

## ğŸ”µ P2: å»ºè®®æ”¹è¿›ï¼ˆæœ‰æ—¶é—´æ—¶ä¼˜åŒ–ï¼‰

### Task 6: ç ”ç©¶å®æ—¶é€šä¿¡æ–¹æ¡ˆ
**è´Ÿè´£äºº**: [å¾…åˆ†é…]
**å·¥æ—¶ä¼°è®¡**: 8å°æ—¶
**æˆªæ­¢æ—¥æœŸ**: [ä¸¤å‘¨å]

**å­ä»»åŠ¡**:
- [ ] è°ƒç ” Server-Sent Events (SSE) åœ¨ Next.js ä¸­çš„å®ç°
- [ ] è¯„ä¼° WebSocket æ–¹æ¡ˆ
- [ ] åˆ›å»º POC åŸå‹
- [ ] æ€§èƒ½å¯¹æ¯”æµ‹è¯•
- [ ] å†³å®šæ˜¯å¦è¿ç§»

**æˆåŠŸæ ‡å‡†**:
- âœ… å®ŒæˆæŠ€æœ¯è°ƒç ”æ–‡æ¡£
- âœ… POC è¯æ˜å¯è¡Œæ€§
- âœ… æœ‰æ¸…æ™°çš„è¿ç§»è®¡åˆ’

**ç›¸å…³æ–‡ä»¶**:
- å¾…å®š

---

### Task 7: æ·»åŠ äº‹åŠ¡æ€§ä¿è¯
**è´Ÿè´£äºº**: [å¾…åˆ†é…]
**å·¥æ—¶ä¼°è®¡**: 4å°æ—¶
**æˆªæ­¢æ—¥æœŸ**: [ä¸‰å‘¨å]

**å­ä»»åŠ¡**:
- [ ] è¯†åˆ«éœ€è¦äº‹åŠ¡ä¿æŠ¤çš„æ“ä½œ
- [ ] ä½¿ç”¨ Drizzle ORM äº‹åŠ¡ API
- [ ] æˆ–å®ç°è¡¥å¿äº‹åŠ¡æ¨¡å¼
- [ ] æµ‹è¯•å¤±è´¥å›æ»šåœºæ™¯

**æˆåŠŸæ ‡å‡†**:
- âœ… å…³é”®æ“ä½œæœ‰äº‹åŠ¡ä¿æŠ¤
- âœ… éƒ¨åˆ†å¤±è´¥èƒ½æ­£ç¡®å›æ»š
- âœ… æ•°æ®ä¸€è‡´æ€§å¾—åˆ°ä¿è¯

**ç›¸å…³æ–‡ä»¶**:
- `src/ai/image/components/conversation/ConversationInput.tsx`
- `src/actions/project-message.ts`

---

### Task 8: å®Œå–„æµ‹è¯•å’Œæ–‡æ¡£
**è´Ÿè´£äºº**: [å¾…åˆ†é…]
**å·¥æ—¶ä¼°è®¡**: 6å°æ—¶
**æˆªæ­¢æ—¥æœŸ**: [æŒç»­è¿›è¡Œ]

**å­ä»»åŠ¡**:
- [ ] ä¸º `useGenerationRecovery` ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ä¸º `parseErrorMessage` ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] æ·»åŠ é›†æˆæµ‹è¯•ï¼šç”ŸæˆçŠ¶æ€æŒä¹…åŒ–æµç¨‹
- [ ] ç¼–å†™æ¶æ„æ–‡æ¡£
- [ ] æ·»åŠ  JSDoc æ³¨é‡Š

**æˆåŠŸæ ‡å‡†**:
- âœ… æµ‹è¯•è¦†ç›–ç‡ > 80%
- âœ… å…³é”® hook æœ‰å®Œæ•´æµ‹è¯•
- âœ… æœ‰æ¸…æ™°çš„æ¶æ„æ–‡æ¡£

**ç›¸å…³æ–‡ä»¶**:
- `src/ai/image/hooks/__tests__/use-generation-recovery.test.ts` (æ–°å¢)
- `src/ai/image/components/__tests__/...` (æ–°å¢)
- `docs/architecture/generation-state-management.md` (æ–°å¢)

---

## ğŸ“… æ—¶é—´è¡¨

### ç¬¬ä¸€å‘¨ï¼ˆæœ¬å‘¨ï¼‰
**é‡ç‚¹**: P0 ä¸¥é‡é—®é¢˜

- [ ] Day 1-2: Task 1 (useGenerationRecovery æ€§èƒ½ä¼˜åŒ–)
- [ ] Day 3-4: Task 2 (è½®è¯¢é”™è¯¯æ¢å¤)
- [ ] Day 5: æµ‹è¯•å’Œä»£ç å®¡æŸ¥

**ç›®æ ‡**: è§£å†³æ‰€æœ‰ P0 é—®é¢˜

---

### ç¬¬äºŒå‘¨
**é‡ç‚¹**: P1 é‡è¦é—®é¢˜

- [ ] Day 1: Task 3 (TypeScript ç±»å‹å®‰å…¨)
- [ ] Day 1: Task 4 (ç§»é™¤é‡å¤å¯¼å…¥)
- [ ] Day 2-3: Task 5 (localStorage é”™è¯¯å¤„ç†)
- [ ] Day 4-5: æµ‹è¯•å’Œæ–‡æ¡£

**ç›®æ ‡**: è§£å†³æ‰€æœ‰ P1 é—®é¢˜ï¼Œæå‡ä»£ç è´¨é‡

---

### ç¬¬ä¸‰å‘¨åŠä»¥å
**é‡ç‚¹**: P2 ä¼˜åŒ–å»ºè®®

- [ ] Week 3: Task 6 (å®æ—¶é€šä¿¡è°ƒç ”)
- [ ] Week 4: Task 7 (äº‹åŠ¡æ€§ä¿è¯)
- [ ] æŒç»­: Task 8 (æµ‹è¯•å’Œæ–‡æ¡£)

**ç›®æ ‡**: é•¿æœŸä¼˜åŒ–å’Œå®Œå–„

---

## ğŸ“ˆ è¿›åº¦è·Ÿè¸ª

### æ£€æŸ¥ç‚¹ 1 (æœ¬å‘¨äº”)
- [ ] P0-1: useGenerationRecovery æ€§èƒ½ä¼˜åŒ– âœ…
- [ ] P0-2: è½®è¯¢é”™è¯¯æ¢å¤ âœ…
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ

### æ£€æŸ¥ç‚¹ 2 (ä¸‹å‘¨äº”)
- [ ] P1-3: TypeScript ç±»å‹å®‰å…¨ âœ…
- [ ] P1-4: ç§»é™¤é‡å¤å¯¼å…¥ âœ…
- [ ] P1-5: localStorage é”™è¯¯å¤„ç† âœ…
- [ ] å®Œæ•´æµ‹è¯•é€šè¿‡
- [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### æ£€æŸ¥ç‚¹ 3 (ä¸¤å‘¨å)
- [ ] P2-6: å®æ—¶é€šä¿¡è°ƒç ”å®Œæˆ
- [ ] å†³å®šæ˜¯å¦å®æ–½
- [ ] æ›´æ–°æŠ€æœ¯è·¯çº¿å›¾

---

## ğŸ¯ KPI å’ŒæˆåŠŸæŒ‡æ ‡

### æ€§èƒ½æŒ‡æ ‡
- **ç›®æ ‡**: è½®è¯¢æ•°æ®ä¼ è¾“é‡å‡å°‘ > 90%
- **æµ‹é‡**: ç›‘æ§ç½‘ç»œè¯·æ±‚å¤§å°before/after
- **å½“å‰**: ~50KB per request
- **ç›®æ ‡**: ~5KB per request

### ç¨³å®šæ€§æŒ‡æ ‡
- **ç›®æ ‡**: ç”Ÿäº§ç¯å¢ƒé”™è¯¯ç‡ < 0.1%
- **æµ‹é‡**: Sentry é”™è¯¯ç›‘æ§
- **å…³æ³¨**: localStorage é”™è¯¯ã€è½®è¯¢è¶…æ—¶

### ä»£ç è´¨é‡æŒ‡æ ‡
- **ç›®æ ‡**: TypeScript strict mode æ— é”™è¯¯
- **ç›®æ ‡**: æµ‹è¯•è¦†ç›–ç‡ > 80%
- **ç›®æ ‡**: ä»£ç é‡å¤ç‡ < 5%

---

## ğŸš¨ é£é™©å’Œä¾èµ–

### æ½œåœ¨é£é™©
1. **æ€§èƒ½ä¼˜åŒ–å¯èƒ½å¼•å…¥æ–° bug**: éœ€è¦å……åˆ†æµ‹è¯•
2. **localStorage ç­–ç•¥å˜æ›´å¯èƒ½å½±å“ç°æœ‰ç”¨æˆ·**: éœ€è¦è¿ç§»ç­–ç•¥
3. **å®æ—¶é€šä¿¡æ–¹æ¡ˆå¤æ‚åº¦é«˜**: å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´

### ç¼“è§£æªæ–½
- æ¯ä¸ª task å®Œæˆåè¿›è¡Œä»£ç å®¡æŸ¥
- åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯
- ä½¿ç”¨ feature flag æ§åˆ¶æ–°åŠŸèƒ½å‘å¸ƒ
- ä¿ç•™æ—§ä»£ç ä½œä¸ºé™çº§æ–¹æ¡ˆ

---

## ğŸ“ å¤‡æ³¨

- æ‰€æœ‰ä»£ç æ›´æ”¹éœ€è¦ç»è¿‡ code review
- é‡å¤§å˜æ›´éœ€è¦åœ¨å›¢é˜Ÿä¼šè®®ä¸Šè®¨è®º
- ä¿æŒä¸äº§å“å›¢é˜Ÿçš„æ²Ÿé€šï¼Œç¡®ä¿æ”¹è¿›ä¸å½±å“ç”¨æˆ·ä½“éªŒ
- å®šæœŸæ›´æ–°æ­¤æ–‡æ¡£ä»¥åæ˜ æœ€æ–°è¿›å±•

---

**æœ€åæ›´æ–°**: 2026-01-08
**å®¡æŸ¥å‘¨æœŸ**: d374972 (feat: implement generation state persistence and recovery)
