# 代码改进建议清单

## P0 - 严重问题（需立即修复）

### 1. 修复 useGenerationRecovery 性能问题
- [ ] 从依赖数组中移除未使用的 `messages`
- [ ] 创建专门的 API 只查询单个消息状态而不是所有消息
- [ ] 估计工时：2小时
- [ ] 影响：显著降低数据库负载和网络流量

### 2. 添加轮询错误恢复机制
- [ ] 实现最大重试次数限制（建议 12 次）
- [ ] 添加最大轮询时间限制（建议 5 分钟）
- [ ] 添加指数退避策略
- [ ] 估计工时：3小时
- [ ] 影响：防止无限轮询导致的资源浪费

---

## P1 - 重要问题（应尽快修复）

### 3. 改进 TypeScript 类型安全
- [ ] 替换 `any` 类型为具体的接口定义
- [ ] 选项 1：定义 TranslationFunction 接口
- [ ] 选项 2：使用泛型约束
- [ ] 估计工时：1小时
- [ ] 影响：恢复类型检查，减少潜在 bug

### 4. 移除重复的动态导入
- [ ] 将 updateAssistantMessage 移到文件顶部导入
- [ ] 清理三处重复的动态导入代码
- [ ] 估计工时：0.5小时
- [ ] 影响：提升代码可读性和性能

### 5. 添加 localStorage 错误处理
- [ ] 实现自定义 storage 对象with try-catch
- [ ] 添加 version 和 migrate 函数
- [ ] 处理 localStorage 满或被禁用的情况
- [ ] 估计工时：2小时
- [ ] 影响：提高应用稳定性

---

## P2 - 建议改进（有时间时优化）

### 6. 考虑实时通信方案
- [ ] 研究 Server-Sent Events (SSE) 可行性
- [ ] 或考虑 WebSocket 实现
- [ ] 替代当前的轮询机制
- [ ] 估计工时：8小时
- [ ] 影响：显著提升用户体验和系统效率

### 7. 添加事务性保证
- [ ] 使用数据库事务包装相关操作
- [ ] 或实现补偿事务模式
- [ ] 估计工时：4小时
- [ ] 影响：确保数据一致性

### 8. 提升代码可维护性
- [ ] 将魔法数字提取为常量
- [ ] 添加配置选项
- [ ] 编写单元测试
- [ ] 添加架构文档
- [ ] 估计工时：6小时
- [ ] 影响：长期维护成本降低

---

## 测试计划

### 单元测试
- [ ] useGenerationRecovery hook 测试
- [ ] parseErrorMessage 函数测试
- [ ] localStorage 错误情况测试

### 集成测试
- [ ] 生成状态持久化流程测试
- [ ] 页面刷新恢复状态测试
- [ ] 并发生成场景测试

### 边界条件测试
- [ ] localStorage 已满
- [ ] 网络断开
- [ ] 生成超时
- [ ] 并发修改冲突

---

## 总结

**本周重点**：
1. 修复性能问题（P0-1, P0-2）
2. 改进类型安全（P1-3）
3. 添加错误处理（P1-5）

**估计总工时**：约 8.5 小时（P0 + P1 优先级）

**下周计划**：
- 考虑实时通信方案（P2-6）
- 完善测试覆盖率

**长期规划**：
- 重构为更健壮的架构
- 添加离线支持
- 性能监控和告警
